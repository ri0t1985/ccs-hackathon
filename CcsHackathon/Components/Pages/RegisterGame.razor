@page "/register-game"
@using System.ComponentModel.DataAnnotations
@using CcsHackathon.Services
@using CcsHackathon.Data
@attribute [Authorize]
@inject IUserContext UserContext
@inject IRegistrationService RegistrationService
@inject ISessionService SessionService
@inject ILogger<RegisterGame> Logger

<PageTitle>Register Game</PageTitle>

<div class="container mt-4">
    @if (nextUpcomingSession != null)
    {
        <div class="alert alert-info mb-3" role="alert">
            <div class="d-flex align-items-center">
                <span class="bi bi-calendar-event me-2" style="font-size: 1.25rem;"></span>
                <div>
                    <strong>Next Upcoming Session:</strong> 
                    <span>@nextUpcomingSession.Date.ToString("dddd, MMMM dd, yyyy")</span>
                </div>
            </div>
        </div>
    }
    
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Register Your Games</h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Logged in as: <strong>@UserContext.DisplayName</strong> (@UserContext.Email)</p>
            
            <EditForm Model="@registrationModel" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary class="alert alert-danger" />
                
                <div class="table-responsive">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td class="align-middle" style="width: 30%;">
                                    <label for="name" class="form-label fw-bold mb-0">User Display Name</label>
                                </td>
                                <td>
                                    <InputText id="name" class="form-control" @bind-Value="registrationModel.Name" />
                                    <ValidationMessage For="@(() => registrationModel.Name)" />
                                </td>
                            </tr>
                            <tr>
                                <td class="align-top" style="width: 30%;">
                                    <label class="form-label fw-bold mb-0">Board Games</label>
                                    <p class="text-muted small mb-0">Select one or more board games</p>
                                </td>
                                <td>
                                    <MultiSelectBoardGameSelector 
                                        SelectedGameIds="@registrationModel.GameIds"
                                        SelectedGameIdsChanged="@OnGamesChanged"
                                        Placeholder="Search board games..."
                                        IsInvalid="@(!registrationModel.GameIds.Any())" />
                                    <ValidationMessage For="@(() => registrationModel.GameIds)" />
                                </td>
                            </tr>
                            <tr>
                                <td class="align-middle" style="width: 30%;">
                                    <label for="sessionId" class="form-label fw-bold mb-0">Session Date <span class="text-danger">*</span></label>
                                </td>
                                <td>
                                    <InputSelect id="sessionId" class="form-select" @bind-Value="registrationModel.SessionId">
                                        <option value="">-- Select a session --</option>
                                        @if (upcomingSessions != null)
                                        {
                                            @foreach (var session in upcomingSessions)
                                            {
                                                <option value="@session.Id">@session.Date.ToString("yyyy-MM-dd")</option>
                                            }
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => registrationModel.SessionId)" />
                                </td>
                            </tr>
                            <tr>
                                <td class="align-top" style="width: 30%;">
                                    <label for="foodRequirements" class="form-label fw-bold mb-0">Food Requirements</label>
                                    <p class="text-muted small mb-0">Optional</p>
                                </td>
                                <td>
                                    <InputTextArea id="foodRequirements" 
                                                  class="form-control" 
                                                  rows="3"
                                                  placeholder="Enter any dietary restrictions or food preferences..."
                                                  @bind-Value="registrationModel.FoodRequirements" />
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" 
                            class="btn @(IsFormValid() ? "btn-primary" : "btn-secondary") btn-lg" 
                            disabled="@(isSubmitting || !IsFormValid())"
                            style="@(!IsFormValid() ? "opacity: 0.6; cursor: not-allowed;" : "")">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <text>Registering...</text>
                        }
                        else
                        {
                            <text>Register</text>
                        }
                    </button>
                </div>
            </EditForm>
            
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(isError ? "alert-danger" : "alert-success") mt-3" role="alert">
                    @message
                </div>
            }
        </div>
    </div>
</div>

@code {
    private RegistrationModel registrationModel = new();
    private string message = string.Empty;
    private bool isSubmitting = false;
    private bool isError = false;
    private List<Session>? upcomingSessions;
    private Session? nextUpcomingSession;

    protected override async Task OnInitializedAsync()
    {
        // Pre-fill name from user context
        registrationModel.Name = UserContext.DisplayName;
        // Start with empty game list
        registrationModel.GameIds = new List<Guid>();
        
        // Load only upcoming (non-past) sessions
        try
        {
            var allSessions = await SessionService.GetAllSessionsAsync();
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            upcomingSessions = allSessions
                .Where(s => !s.IsCancelled && s.Date >= today)
                .OrderBy(s => s.Date)
                .ToList();
            
            // Get the next upcoming session for the header
            nextUpcomingSession = upcomingSessions.FirstOrDefault();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading sessions");
            upcomingSessions = new List<Session>();
            nextUpcomingSession = null;
        }
    }
    
    private bool IsFormValid()
    {
        // Check if all required fields are valid
        if (string.IsNullOrWhiteSpace(registrationModel.Name))
            return false;
            
        if (!registrationModel.SessionId.HasValue)
            return false;
            
        // Check if at least one game is provided
        var hasGames = registrationModel.GameIds.Any();
        if (!hasGames)
            return false;
            
        // Validate that selected session is not in the past
        if (registrationModel.SessionId.HasValue)
        {
            var selectedSession = upcomingSessions?.FirstOrDefault(s => s.Id == registrationModel.SessionId.Value);
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            if (selectedSession == null || selectedSession.Date < today)
                return false;
        }
        
        return true;
    }
    
    private void HandleInvalidSubmit()
    {
        message = "Please correct the errors above before submitting.";
        isError = true;
    }

    private void OnGamesChanged(List<Guid> gameIds)
    {
        registrationModel.GameIds = gameIds;
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        isError = false;
        message = string.Empty;

        try
        {
            // Validate session is not in the past
            if (!registrationModel.SessionId.HasValue)
            {
                message = "Please select a session date.";
                isError = true;
                isSubmitting = false;
                return;
            }
            
            var selectedSession = upcomingSessions?.FirstOrDefault(s => s.Id == registrationModel.SessionId.Value);
            var today = DateOnly.FromDateTime(DateTime.UtcNow);
            if (selectedSession == null)
            {
                message = "The selected session is invalid or has passed. Please select a valid upcoming session.";
                isError = true;
                isSubmitting = false;
                return;
            }
            
            if (selectedSession.Date < today)
            {
                message = "Cannot register for a past session. Please select an upcoming session.";
                isError = true;
                isSubmitting = false;
                return;
            }

            if (registrationModel.GameIds.Count == 0)
            {
                message = "Please add at least one board game.";
                isError = true;
                isSubmitting = false;
                return;
            }

            var registration = await RegistrationService.CreateRegistrationAsync(
                UserContext.UserId,
                registrationModel.Name,
                string.IsNullOrWhiteSpace(registrationModel.FoodRequirements) 
                    ? null 
                    : registrationModel.FoodRequirements.Trim(),
                registrationModel.GameIds,
                registrationModel.SessionId
            );

            message = $"Thank you, {registrationModel.Name}! Your registration for {registrationModel.GameIds.Count} game(s) has been saved successfully.";
            
            // Reset form
            registrationModel = new RegistrationModel
            {
                Name = UserContext.DisplayName,
                GameIds = new List<Guid>()
            };
            registrationModel.SessionId = null;
        }
        catch (Exception ex)
        {
            message = $"An error occurred while saving your registration: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class RegistrationModel
    {
        [Required(ErrorMessage = "Name is required")]
        public string Name { get; set; } = string.Empty;

        public List<Guid> GameIds { get; set; } = new();

        public string? FoodRequirements { get; set; }
        
        [Required(ErrorMessage = "Session date is required")]
        public Guid? SessionId { get; set; }
    }
}
