@page "/sessions/{SessionId:guid}/attendees"
@using CcsHackathon.Services
@using CcsHackathon.Data
@attribute [Authorize]
@inject ISessionAttendeesService SessionAttendeesService
@inject ILogger<SessionAttendees> Logger
@inject NavigationManager Navigation

<PageTitle>Session Attendees</PageTitle>

<div class="container mt-4">
    @if (attendeesInfo == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading attendees...</p>
        </div>
    }
    else if (attendeesInfo.Session == null)
    {
        <div class="alert alert-warning" role="alert">
            <strong>Session not found.</strong> The session may have been cancelled or does not exist.
        </div>
        <div class="mt-3">
            <a href="/sessions" class="btn btn-secondary">Back to Sessions</a>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Session Attendees</h2>
                <p class="text-muted mb-0">Session Date: <strong>@attendeesInfo.Session.Date.ToString("yyyy-MM-dd")</strong></p>
            </div>
            <a href="/sessions" class="btn btn-secondary">Back to Sessions</a>
        </div>

        @if (!attendeesInfo.Attendees.Any())
        {
            <div class="alert alert-info" role="alert">
                <strong>No attendees registered yet.</strong> No one has registered for this session.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Board Games</th>
                            <th>Food Requirements</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var attendee in attendeesInfo.Attendees)
                        {
                            <tr>
                                <td><strong>@attendee.UserDisplayName</strong></td>
                                <td>
                                    @if (attendee.BoardGames.Any())
                                    {
                                        <ul class="list-unstyled mb-0">
                                            @foreach (var game in attendee.BoardGames)
                                            {
                                                <li>• @game</li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No games registered</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrWhiteSpace(attendee.FoodRequirements))
                                    {
                                        <text>@attendee.FoodRequirements</text>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <div class="mt-3 text-muted small">
                <p>Total attendees: <strong>@attendeesInfo.Attendees.Count</strong></p>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public Guid SessionId { get; set; }

    private SessionAttendeesInfo? attendeesInfo;

    protected override async Task OnInitializedAsync()
    {
        await LoadAttendeesAsync();
    }

    private async Task LoadAttendeesAsync()
    {
        try
        {
            attendeesInfo = await SessionAttendeesService.GetSessionAttendeesAsync(SessionId);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading attendees for session {SessionId}", SessionId);
            attendeesInfo = null;
        }
    }
}

