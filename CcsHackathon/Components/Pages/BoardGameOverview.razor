@page "/board-games"
@using CcsHackathon.Services
@using CcsHackathon.Data
@attribute [Authorize]
@inject IBoardGameOverviewService BoardGameOverviewService
@inject ISessionService SessionService
@inject IUserContext UserContext
@inject ILogger<BoardGameOverview> Logger

<PageTitle>Board Games Overview</PageTitle>

<div class="container mt-4">
    <h2>Registered Board Games</h2>
    <p class="text-muted">Overview of all board games that have been registered</p>
    
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="sessionFilter" class="form-label">Filter by Session</label>
            <InputSelect id="sessionFilter" class="form-select" @bind-Value="selectedSessionId" @onchange="OnSessionFilterChanged">
                <option value="">-- All Sessions --</option>
                @if (sessions != null)
                {
                    @foreach (var session in sessions)
                    {
                        <option value="@session.Id">@session.Date.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</option>
                    }
                }
            </InputSelect>
        </div>
    </div>
    
    @if (games == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading board games...</p>
        </div>
    }
    else if (!games.Any())
    {
        <div class="alert alert-info" role="alert">
            <strong>No games registered yet.</strong> 
            <a href="/register-game" class="alert-link">Register a game</a> to get started.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>
                            <button class="btn btn-link p-0 text-decoration-none text-reset fw-bold" 
                                    @onclick="() => SortBy(nameof(BoardGameOverviewItem.GameName))"
                                    style="border: none; background: none;">
                                Game Name
                                @if (sortColumn == nameof(BoardGameOverviewItem.GameName))
                                {
                                    <span class="ms-1">@(sortAscending ? "‚Üë" : "‚Üì")</span>
                                }
                            </button>
                        </th>
                        <th>Description/Summary</th>
                        <th>
                            <button class="btn btn-link p-0 text-decoration-none text-reset fw-bold" 
                                    @onclick="() => SortBy(nameof(BoardGameOverviewItem.Complexity))"
                                    style="border: none; background: none;">
                                Complexity
                                @if (sortColumn == nameof(BoardGameOverviewItem.Complexity))
                                {
                                    <span class="ms-1">@(sortAscending ? "‚Üë" : "‚Üì")</span>
                                }
                            </button>
                        </th>
                        <th>Setup Time</th>
                        <th>AI Data</th>
                        <th>Participants</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in sortedGames)
                    {
                        var participantCount = participantCounts.ContainsKey(game.GameName) ? participantCounts[game.GameName] : 0;
                        var isParticipant = participantStatus.ContainsKey(game.GameName) && participantStatus[game.GameName];
                        <tr>
                            <td><strong>@game.GameName</strong></td>
                            <td>
                                @{
                                    var truncatedDesc = TruncateDescription(game.Summary, out var showMore, 10);
                                    var gameNameKey = $"desc_{game.GameName}";
                                    var isExpanded = expandedDescriptions.Contains(gameNameKey);
                                }
                                @if (string.IsNullOrWhiteSpace(game.Summary))
                                {
                                    <span class="text-muted fst-italic">No description available</span>
                                }
                                else if (showMore && !isExpanded)
                                {
                                    <span>@truncatedDesc</span>
                                    <button class="btn btn-link btn-sm p-0 ms-1 text-primary" @onclick="() => ToggleDescription(gameNameKey)">
                                        Show more
                                    </button>
                                }
                                else if (showMore && isExpanded)
                                {
                                    <div>@game.Summary</div>
                                    <button class="btn btn-link btn-sm p-0 mt-1 text-primary" @onclick="() => ToggleDescription(gameNameKey)">
                                        Show less
                                    </button>
                                }
                                else
                                {
                                    <span>@game.Summary</span>
                                }
                            </td>
                            <td>
                                @if (game.Complexity.HasValue)
                                {
                                    <div>
                                        @((MarkupString)RenderStarRating(game.Complexity.Value))
                                        <span class="ms-2 small text-muted">@game.Complexity.Value.ToString("F1")/5.0</span>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">‚Äî</span>
                                }
                            </td>
                            <td>
                                @if (game.TimeToSetupMinutes.HasValue)
                                {
                                    <text>@game.TimeToSetupMinutes.Value min</text>
                                }
                                else
                                {
                                    <span class="text-muted">‚Äî</span>
                                }
                            </td>
                            <td>
                                @if (game.HasAiData)
                                {
                                    <span class="badge bg-success">Available</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Pending</span>
                                }
                            </td>
                            <td>
                                @if (selectedSessionId.HasValue)
                                {
                                    <span class="badge bg-info">@participantCount</span>
                                }
                                else
                                {
                                    <span class="text-muted">‚Äî</span>
                                }
                            </td>
                            <td>
                                @if (selectedSessionId.HasValue)
                                {
                                    @if (isParticipant)
                                    {
                                        <button class="btn btn-sm btn-outline-danger" 
                                                @onclick="() => RemoveParticipant(game.GameName)"
                                                title="Remove interest">
                                            ‚ùå Not Interested
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-primary" 
                                                @onclick="() => AddParticipant(game.GameName)"
                                                title="Express interest">
                                            üëç I want to play this
                                        </button>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted small">Select a session</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 text-muted small">
            <p>Showing <strong>@sortedGames.Count()</strong> game(s)</p>
        </div>
    }
</div>

@code {
    private IEnumerable<BoardGameOverviewItem>? games;
    private IEnumerable<BoardGameOverviewItem> sortedGames = Enumerable.Empty<BoardGameOverviewItem>();
    private string sortColumn = nameof(BoardGameOverviewItem.GameName);
    private bool sortAscending = true;
    private List<Session>? sessions;
    private Guid? selectedSessionId;
    private Dictionary<string, int> participantCounts = new();
    private Dictionary<string, bool> participantStatus = new();
    private HashSet<string> expandedDescriptions = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            sessions = (await SessionService.GetAllSessionsAsync()).ToList();
            await LoadGamesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading board games overview");
            games = Enumerable.Empty<BoardGameOverviewItem>();
            sortedGames = Enumerable.Empty<BoardGameOverviewItem>();
        }
    }

    private async Task LoadGamesAsync()
    {
        try
        {
            games = await BoardGameOverviewService.GetBoardGamesAsync(selectedSessionId);
            ApplySorting();
            
            if (selectedSessionId.HasValue)
            {
                await LoadParticipantDataAsync();
            }
            else
            {
                participantCounts.Clear();
                participantStatus.Clear();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading games");
        }
    }

    private async Task LoadParticipantDataAsync()
    {
        if (!selectedSessionId.HasValue || games == null) return;

        participantCounts.Clear();
        participantStatus.Clear();

        try
        {
            foreach (var game in games)
            {
                var count = await SessionService.GetParticipantCountAsync(selectedSessionId.Value, game.GameName);
                participantCounts[game.GameName] = count;
                
                var isParticipant = await SessionService.IsParticipantAsync(selectedSessionId.Value, game.GameName, UserContext.UserId);
                participantStatus[game.GameName] = isParticipant;
            }
            
            // Force UI update
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading participant data");
        }
    }

    private async Task OnSessionFilterChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        selectedSessionId = string.IsNullOrWhiteSpace(value) ? null : Guid.Parse(value);
        await LoadGamesAsync();
    }

    private async Task AddParticipant(string gameName)
    {
        if (!selectedSessionId.HasValue) return;

        try
        {
            var success = await SessionService.AddParticipantAsync(
                selectedSessionId.Value,
                gameName,
                UserContext.UserId,
                UserContext.DisplayName
            );

            if (success)
            {
                await LoadParticipantDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error adding participant");
        }
    }

    private async Task RemoveParticipant(string gameName)
    {
        if (!selectedSessionId.HasValue) return;

        try
        {
            var success = await SessionService.RemoveParticipantAsync(
                selectedSessionId.Value,
                gameName,
                UserContext.UserId
            );

            if (success)
            {
                await LoadParticipantDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing participant");
        }
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplySorting();
    }

    private void ApplySorting()
    {
        if (games == null)
        {
            sortedGames = Enumerable.Empty<BoardGameOverviewItem>();
            return;
        }

        sortedGames = sortColumn switch
        {
            nameof(BoardGameOverviewItem.GameName) => sortAscending
                ? games.OrderBy(g => g.GameName)
                : games.OrderByDescending(g => g.GameName),
            nameof(BoardGameOverviewItem.Complexity) => sortAscending
                ? games.OrderBy(g => g.Complexity ?? decimal.MaxValue)
                : games.OrderByDescending(g => g.Complexity ?? decimal.MinValue),
            _ => games.OrderBy(g => g.GameName)
        };
    }

    private void ToggleDescription(string key)
    {
        if (expandedDescriptions.Contains(key))
        {
            expandedDescriptions.Remove(key);
        }
        else
        {
            expandedDescriptions.Add(key);
        }
    }
    
    private string RenderStarRating(decimal value, decimal maxValue = 5.0m)
    {
        var fullStars = (int)Math.Floor(value);
        var hasHalfStar = value % 1 >= 0.5m;
        var emptyStars = (int)maxValue - fullStars - (hasHalfStar ? 1 : 0);
        
        var html = "";
        for (int i = 0; i < fullStars; i++)
        {
            html += "<span class=\"text-warning\">‚òÖ</span>";
        }
        if (hasHalfStar)
        {
            html += "<span class=\"text-warning\" style=\"opacity: 0.5;\">‚òÖ</span>";
        }
        for (int i = 0; i < emptyStars; i++)
        {
            html += "<span class=\"text-muted\">‚òÜ</span>";
        }
        return html;
    }
    
    private string TruncateDescription(string? text, out bool shouldShowMore, int maxWords = 10)
    {
        shouldShowMore = false;
        if (string.IsNullOrWhiteSpace(text))
        {
            return string.Empty;
        }
        
        var words = text.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        shouldShowMore = words.Length > maxWords;
        
        if (shouldShowMore)
        {
            return string.Join(" ", words.Take(maxWords)) + "...";
        }
        
        return text;
    }
}

