@using CcsHackathon.Services
@using CcsHackathon.Data
@implements IDisposable
@inject IBoardGameService BoardGameService
@inject ILogger<MultiSelectBoardGameSelector> Logger

<div class="multiselect-board-game-container position-relative">
    <div class="dropdown @(ShowDropdown ? "show" : "")">
        <div class="selected-games-container mb-2">
            @if (SelectedGames.Any())
            {
                @foreach (var game in SelectedGames)
                {
                    <span class="badge bg-primary me-1 mb-1" style="font-size: 0.875rem; padding: 0.5rem;">
                        @game.Name
                        <button type="button" 
                                class="btn-close btn-close-white ms-1" 
                                style="font-size: 0.75rem;"
                                @onclick="() => RemoveGame(game.Id)"
                                @onmousedown:preventDefault="true"
                                aria-label="Remove"></button>
                    </span>
                }
            }
        </div>
        
        <div class="input-group">
            <input type="text" 
                   class="form-control @(IsInvalid ? "is-invalid" : "")" 
                   placeholder="@Placeholder"
                   value="@SearchTerm"
                   @oninput="HandleInput"
                   @onkeydown="HandleKeyDown"
                   @onfocus="HandleFocus"
                   @onblur="HandleBlur" />
        </div>
        
        @if (ShowDropdown && (SearchResults.Any() || ShowCreateOption || (string.IsNullOrWhiteSpace(SearchTerm) && RecentGames.Any())))
        {
            <div class="dropdown-menu show position-absolute w-100" style="max-height: 300px; overflow-y: auto; z-index: 1050; top: 100%; left: 0; margin-top: 0.125rem;">
                @if (string.IsNullOrWhiteSpace(SearchTerm) && RecentGames.Any())
                {
                    <div class="dropdown-header">Recent Games</div>
                    @foreach (var game in RecentGames)
                    {
                        var isSelected = SelectedGames.Any(g => g.Id == game.Id);
                        <button type="button" 
                                class="dropdown-item @(isSelected ? "disabled" : "")"
                                disabled="@isSelected"
                                @onclick="() => AddGame(game)"
                                @onmousedown:preventDefault="true">
                            @game.Name
                            @if (isSelected)
                            {
                                <span class="text-muted ms-2">(already selected)</span>
                            }
                        </button>
                    }
                    <div class="dropdown-divider"></div>
                }
                
                @if (!string.IsNullOrWhiteSpace(SearchTerm))
                {
                    @{
                        var resultsList = SearchResults.ToList();
                    }
                    @for (int i = 0; i < resultsList.Count; i++)
                    {
                        var game = resultsList[i];
                        var gameIndex = i;
                        var isSelected = SelectedGames.Any(g => g.Id == game.Id);
                        <button type="button" 
                                class="dropdown-item @(SelectedIndex == gameIndex ? "active" : "") @(isSelected ? "disabled" : "")"
                                disabled="@isSelected"
                                @onclick="() => AddGame(game)"
                                @onmousedown:preventDefault="true"
                                @onmouseenter="() => SetHoveredIndex(gameIndex)">
                            @game.Name
                            @if (isSelected)
                            {
                                <span class="text-muted ms-2">(already selected)</span>
                            }
                        </button>
                    }
                    @if (ShowCreateOption && !string.IsNullOrWhiteSpace(SearchTerm))
                    {
                        var createIndex = resultsList.Count;
                        <div class="dropdown-divider"></div>
                        <button type="button" 
                                class="dropdown-item text-primary fw-bold @(SelectedIndex == createIndex ? "active" : "")"
                                @onclick="CreateNewGame"
                                @onmousedown:preventDefault="true"
                                @onmouseenter="() => SetHoveredIndex(createIndex)">
                            + Add new game: "@SearchTerm"
                        </button>
                    }
                }
            </div>
        }
    </div>
    
    @if (IsLoading)
    {
        <div class="position-absolute end-0 top-50 translate-middle-y" style="right: 0.5rem; z-index: 10;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="invalid-feedback d-block">@ErrorMessage</div>
    }
</div>

@code {
    [Parameter] public List<Guid> SelectedGameIds { get; set; } = new();
    [Parameter] public EventCallback<List<Guid>> SelectedGameIdsChanged { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Search board games...";
    [Parameter] public bool IsInvalid { get; set; }
    
    private string SearchTerm { get; set; } = string.Empty;
    private List<BoardGame> SelectedGames { get; set; } = new();
    private IEnumerable<BoardGame> SearchResults { get; set; } = Enumerable.Empty<BoardGame>();
    private List<BoardGame> RecentGames { get; set; } = new();
    private bool ShowDropdown { get; set; } = false;
    private bool ShowCreateOption { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private string ErrorMessage { get; set; } = string.Empty;
    private int SelectedIndex { get; set; } = -1;
    private System.Threading.Timer? _debounceTimer;
    private const int DebounceDelayMs = 300;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentGames();
        await LoadSelectedGames();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadSelectedGames();
    }

    private async Task LoadRecentGames()
    {
        try
        {
            RecentGames = (await BoardGameService.GetRecentBoardGamesAsync(5)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading recent board games");
            RecentGames = new List<BoardGame>();
        }
    }

    private async Task LoadSelectedGames()
    {
        if (SelectedGameIds == null || !SelectedGameIds.Any())
        {
            SelectedGames = new List<BoardGame>();
            return;
        }

        try
        {
            var games = new List<BoardGame>();
            foreach (var id in SelectedGameIds)
            {
                var game = await BoardGameService.GetBoardGameByIdAsync(id);
                if (game != null)
                {
                    games.Add(game);
                }
            }
            SelectedGames = games;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading selected board games");
            SelectedGames = new List<BoardGame>();
        }
    }

    private async void HandleInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        SearchTerm = value;
        ErrorMessage = string.Empty;
        
        // Debounce the search
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await PerformSearch();
                StateHasChanged();
            });
        }, null, DebounceDelayMs, Timeout.Infinite);
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            SearchResults = Enumerable.Empty<BoardGame>();
            ShowCreateOption = false;
            ShowDropdown = true; // Show recent games
            IsLoading = false;
            return;
        }

        IsLoading = true;
        ShowDropdown = true;
        
        try
        {
            SearchResults = await BoardGameService.SearchBoardGamesAsync(SearchTerm);
            
            // Check if exact match exists (case-insensitive)
            var exactMatch = SearchResults.Any(g => 
                g.Name.Equals(SearchTerm, StringComparison.OrdinalIgnoreCase));
            
            // Show create option if no exact match and search term is not empty
            ShowCreateOption = !exactMatch && !string.IsNullOrWhiteSpace(SearchTerm.Trim());
            
            SelectedIndex = -1;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error searching board games");
            ErrorMessage = "An error occurred while searching. Please try again.";
            SearchResults = Enumerable.Empty<BoardGame>();
            ShowCreateOption = false;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AddGame(BoardGame game)
    {
        if (SelectedGames.Any(g => g.Id == game.Id))
        {
            return; // Already selected
        }

        SelectedGames.Add(game);
        SelectedGameIds.Add(game.Id);
        SearchTerm = string.Empty;
        ShowDropdown = false;
        SelectedIndex = -1;
        
        await SelectedGameIdsChanged.InvokeAsync(SelectedGameIds);
        await PerformSearch(); // Refresh to show updated state
    }

    private async Task RemoveGame(Guid gameId)
    {
        SelectedGames.RemoveAll(g => g.Id == gameId);
        SelectedGameIds.RemoveAll(id => id == gameId);
        
        await SelectedGameIdsChanged.InvokeAsync(SelectedGameIds);
    }

    private async Task CreateNewGame()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm?.Trim()))
        {
            ErrorMessage = "Please enter a game name.";
            return;
        }

        IsLoading = true;
        ErrorMessage = string.Empty;
        
        try
        {
            // Check if game already exists
            var exists = await BoardGameService.BoardGameExistsAsync(SearchTerm);
            if (exists)
            {
                ErrorMessage = "This game already exists. Please select it from the list.";
                await PerformSearch();
                return;
            }

            var newGame = await BoardGameService.CreateBoardGameAsync(SearchTerm);
            await AddGame(newGame);
            await LoadRecentGames(); // Refresh recent games
        }
        catch (InvalidOperationException ex)
        {
            ErrorMessage = ex.Message;
            await PerformSearch();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating board game");
            ErrorMessage = "An error occurred while creating the game. Please try again.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void HandleFocus()
    {
        ShowDropdown = true;
    }

    private async void HandleBlur()
    {
        // Delay to allow click events to fire
        await Task.Delay(200);
        ShowDropdown = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (!ShowDropdown) return;

        var resultsList = SearchResults.ToList();
        var totalItems = resultsList.Count + (ShowCreateOption ? 1 : 0);

        switch (e.Key)
        {
            case "ArrowDown":
                SelectedIndex = (SelectedIndex + 1) % totalItems;
                break;
            case "ArrowUp":
                SelectedIndex = SelectedIndex <= 0 ? totalItems - 1 : SelectedIndex - 1;
                break;
            case "Enter":
                if (SelectedIndex >= 0 && SelectedIndex < resultsList.Count)
                {
                    await AddGame(resultsList[SelectedIndex]);
                }
                else if (SelectedIndex == resultsList.Count && ShowCreateOption)
                {
                    await CreateNewGame();
                }
                break;
            case "Escape":
                ShowDropdown = false;
                SelectedIndex = -1;
                break;
        }
    }

    private void SetHoveredIndex(int index)
    {
        SelectedIndex = index;
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}

